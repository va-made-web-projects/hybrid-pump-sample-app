"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([[6193],{1889:($,S,r)=>{r.d(S,{Wi:()=>F,__:()=>D});var D=function(l){return l.Documents="DOCUMENTS",l.Data="DATA",l.Library="LIBRARY",l.Cache="CACHE",l.External="EXTERNAL",l.ExternalStorage="EXTERNAL_STORAGE",l}(D||{}),F=function(l){return l.UTF8="utf8",l.ASCII="ascii",l.UTF16="utf16",l}(F||{})},6193:($,S,r)=>{r.r(S),r.d(S,{DataPageModule:()=>x});var D=r(177),F=r(4341),d=r(4742),E=r(486),l=r(467),b=r(5083),T=r(1889);const C=(0,b.F3)("Filesystem",{web:()=>r.e(2937).then(r.bind(r,2937)).then(a=>new a.FilesystemWeb)});var e=r(4438),P=r(8263),h=r(9855);let u=(()=>{var a;class g{transform(t){return(t-1750)/-50}}return(a=g).\u0275fac=function(t){return new(t||a)},a.\u0275pipe=e.EJ8({name:"millivoltsToInches",type:a,pure:!0,standalone:!0}),g})();function m(a,g){if(1&a&&(e.j41(0,"ion-item")(1,"ion-label"),e.EFF(2,"Current Time Recorded: "),e.k0s(),e.j41(3,"ion-badge"),e.EFF(4),e.k0s()()),2&a){const o=e.XpG();e.R7$(4),e.JRh(o.formatTime(o.currentPage))}}function s(a,g){if(1&a&&(e.j41(0,"ion-item")(1,"ion-label"),e.EFF(2,"Total Pages: "),e.k0s(),e.j41(3,"ion-badge"),e.EFF(4),e.k0s()()),2&a){const o=e.XpG();e.R7$(4),e.JRh(o.currentPage)}}function c(a,g){if(1&a&&(e.j41(0,"tr")(1,"td"),e.EFF(2),e.nI1(3,"date"),e.k0s(),e.j41(4,"td"),e.EFF(5),e.nI1(6,"millivoltsToInches"),e.k0s(),e.j41(7,"td"),e.EFF(8),e.k0s(),e.j41(9,"td"),e.EFF(10),e.k0s(),e.j41(11,"td"),e.EFF(12),e.k0s(),e.j41(13,"td"),e.EFF(14),e.nI1(15,"millivoltsToInches"),e.k0s(),e.j41(16,"td"),e.EFF(17),e.nI1(18,"millivoltsToInches"),e.k0s()()),2&a){const o=g.$implicit;e.R7$(2),e.JRh(e.i5U(3,7,o.timestamp,"yyyy-MM-dd HH:mm:ss")),e.R7$(3),e.JRh(e.bMT(6,10,o.sensorValue)),e.R7$(3),e.JRh(o.isMotorRunning?"Running":"Stopped"),e.R7$(2),e.JRh(o.pumpMode),e.R7$(2),e.JRh(o.batteryReading),e.R7$(2),e.JRh(e.bMT(15,12,o.highThreshold)),e.R7$(3),e.JRh(e.bMT(18,14,o.lowThreshold))}}function i(a,g){if(1&a&&(e.j41(0,"div")(1,"h3"),e.EFF(2,"First Page Data:"),e.k0s(),e.j41(3,"table")(4,"thead")(5,"tr")(6,"th"),e.EFF(7,"Page Number"),e.k0s(),e.j41(8,"th"),e.EFF(9,"Data"),e.k0s(),e.j41(10,"th"),e.EFF(11,"Motor"),e.k0s(),e.j41(12,"th"),e.EFF(13,"Pump Mode"),e.k0s(),e.j41(14,"th"),e.EFF(15,"Battery"),e.k0s(),e.j41(16,"th"),e.EFF(17,"Low Threshold"),e.k0s(),e.j41(18,"th"),e.EFF(19,"High Threshold"),e.k0s()()(),e.j41(20,"tbody"),e.DNE(21,c,19,16,"tr",2),e.k0s()()()),2&a){const o=e.XpG();e.R7$(21),e.Y8G("ngForOf",o.first_page)}}function R(a,g){if(1&a&&(e.j41(0,"tr")(1,"td"),e.EFF(2),e.nI1(3,"date"),e.k0s(),e.j41(4,"td"),e.EFF(5),e.nI1(6,"millivoltsToInches"),e.k0s(),e.j41(7,"td"),e.EFF(8),e.k0s(),e.j41(9,"td"),e.EFF(10),e.k0s(),e.j41(11,"td"),e.EFF(12),e.k0s(),e.j41(13,"td"),e.EFF(14),e.nI1(15,"millivoltsToInches"),e.k0s(),e.j41(16,"td"),e.EFF(17),e.nI1(18,"millivoltsToInches"),e.k0s()()),2&a){const o=g.$implicit;e.R7$(2),e.JRh(e.i5U(3,7,o.timestamp,"yyyy-MM-dd HH:mm:ss")),e.R7$(3),e.JRh(e.bMT(6,10,o.sensorValue)),e.R7$(3),e.JRh(o.isMotorRunning?"Running":"Stopped"),e.R7$(2),e.JRh(o.pumpMode),e.R7$(2),e.JRh(o.batteryReading),e.R7$(2),e.JRh(e.bMT(15,12,o.highThreshold)),e.R7$(3),e.JRh(e.bMT(18,14,o.lowThreshold))}}function f(a,g){if(1&a&&(e.j41(0,"div")(1,"h3"),e.EFF(2,"Last Page Data:"),e.k0s(),e.j41(3,"table")(4,"thead")(5,"tr")(6,"th"),e.EFF(7,"Page Number"),e.k0s(),e.j41(8,"th"),e.EFF(9,"Data"),e.k0s(),e.j41(10,"th"),e.EFF(11,"Motor"),e.k0s(),e.j41(12,"th"),e.EFF(13,"Pump Mode"),e.k0s(),e.j41(14,"th"),e.EFF(15,"Battery"),e.k0s(),e.j41(16,"th"),e.EFF(17,"Low Threshold"),e.k0s(),e.j41(18,"th"),e.EFF(19,"High Threshold"),e.k0s()()(),e.j41(20,"tbody"),e.DNE(21,R,19,16,"tr",2),e.k0s()()()),2&a){const o=e.XpG();e.R7$(21),e.Y8G("ngForOf",o.last_page)}}let y=(()=>{var a;class g{constructor(t){this.pageDataService=t,this.currentPage=null,this.allPagesData=[],this.groupedData={},this.pagesDataSignal=(0,e.vPA)([]),this.first_page=[],this.last_page=[]}ngOnInit(){var t=this;return(0,l.A)(function*(){yield t.onReadPageData(),t.groupedData=t.groupDataBySecond(t.allPagesData)})()}formatTime(t){return this.calculateRecordedTime(t)}calculateRecordedTime(t){const n=16*t;return`${Math.floor(n/3600)}h ${Math.floor(n%3600/60)}m ${n%60}s`}onReadPageData(){var t=this;return(0,l.A)(function*(){console.log("Reading page data");try{t.currentPage=yield t.pageDataService.readCurrentPage(),t.first_page=(yield t.pageDataService.readSinglePage(0))||[];let n=t.currentPage-1;n<0&&(n=0),t.last_page=(yield t.pageDataService.readSinglePage(n))||[],t.pagesDataSignal.set(t.first_page.concat(t.last_page))}catch(n){console.error("Error reading page data:",n)}})()}groupDataBySecond(t){const n={};return t.forEach(p=>{const v=Math.floor(p.timestamp/1e3).toString();n[v]||(n[v]=[]),n[v].push(p)}),n}}return(a=g).\u0275fac=function(t){return new(t||a)(e.rXU(P.P))},a.\u0275cmp=e.VBU({type:a,selectors:[["app-page-data-reader"]],decls:11,vars:4,consts:[[3,"click"],[4,"ngIf"],[4,"ngFor","ngForOf"]],template:function(t,n){1&t&&(e.j41(0,"div"),e.nrm(1,"hr"),e.j41(2,"ion-item")(3,"ion-label"),e.EFF(4,"Page Data Reader"),e.k0s(),e.j41(5,"ion-button",0),e.bIt("click",function(){return n.onReadPageData()}),e.EFF(6,"Refresh Page Data"),e.k0s()(),e.DNE(7,m,5,1,"ion-item",1)(8,s,5,1,"ion-item",1)(9,i,22,1,"div",1)(10,f,22,1,"div",1),e.k0s()),2&t&&(e.R7$(7),e.Y8G("ngIf",null!==n.currentPage),e.R7$(),e.Y8G("ngIf",null!==n.currentPage),e.R7$(),e.Y8G("ngIf",n.first_page.length>0),e.R7$(),e.Y8G("ngIf",n.last_page.length>0))},dependencies:[D.Sq,D.bT,d.In,d.Jm,d.uz,d.he,D.vh,u],styles:[".custom-progress-bar[_ngcontent-%COMP%]{--background: #f0f0f0;--progress-background: linear-gradient(90deg, #4caf50, #81c784);--buffer-background: rgba(0, 0, 0, .1);--height: 28px;--border-radius: 8px;--box-shadow: 0 2px 4px rgba(0, 0, 0, .2);width:75%;margin:20px 12.5%}td[_ngcontent-%COMP%]:nth-child(2n), th[_ngcontent-%COMP%]:nth-child(2n){background-color:#666}"]}),g})();function I(a,g){if(1&a){const o=e.RV6();e.j41(0,"div",5)(1,"ion-button",6),e.bIt("click",function(){e.eBV(o);const n=e.XpG();return e.Njj(n.download())}),e.EFF(2,"Download Data"),e.k0s()()}}function j(a,g){if(1&a&&(e.j41(0,"div"),e.nrm(1,"ion-progress-bar",7),e.k0s()),2&a){const o=e.XpG(2);e.R7$(),e.Y8G("value",o.bluetoothDataService.progress())}}function U(a,g){if(1&a&&(e.j41(0,"ion-card")(1,"ion-card-content")(2,"ion-label"),e.EFF(3,"Downloading..."),e.k0s(),e.DNE(4,j,2,1,"div",4),e.k0s()()),2&a){const o=e.XpG();e.R7$(4),e.Y8G("ngIf",o.bluetoothDataService.progress()<1)}}const A=[{path:"",component:(()=>{var a;class g{constructor(t,n){this.pageDataService=t,this.bluetoothDataService=n,this.data=[],this.groupedData={},this.isDownloading=!1}ngOnInit(){}downloadPageData(){var t=this;return(0,l.A)(function*(){t.isDownloading=!0,console.log("Reading page data");try{yield t.pageDataService.readCurrentPage(),yield t.pageDataService.readAllPages().finally(()=>{t.isDownloading=!1})}catch(n){console.error("Error reading page data:",n)}})()}download(){var t=this;return(0,l.A)(function*(){yield t.downloadPageData();const n=yield t.promptSaveLocation();if(!n)return void console.log("Save location not specified by user.");const p=`pump_data-${(new Date).getTime()}.csv`,v="documents"===n?T.__.Documents:T.__.Cache;t.saveCSV(t.pageDataService.allPageData(),p,v)})()}promptSaveLocation(){return(0,l.A)(function*(){return window.confirm("Save to Documents? Click Cancel for Cache.")?"documents":"cache"})()}saveCSV(t,n,p){var v=this;return(0,l.A)(function*(){const _=v.convertToCSV(t);try{if(b.Ii.isNativePlatform()){const k=yield C.writeFile({path:n,data:_,directory:p,encoding:T.Wi.UTF8});console.log("File saved at:",k.uri)}else v.downloadCSVWeb(_,n)}catch(k){console.error("Error saving file:",k)}})()}downloadCSVWeb(t,n){const p=new Blob([t],{type:"text/csv"}),v=document.createElement("a");v.href=URL.createObjectURL(p),v.download=n,v.click(),URL.revokeObjectURL(v.href)}groupDataByMinute(t){const n={};return t.forEach(p=>{const _=new Date(p.date).toISOString().substring(0,16)+":00.000";n[_]||(n[_]=[]),n[_].push(p)}),n}writeFile(t,n){return(0,l.A)(function*(){yield C.writeFile({path:n,data:t,directory:T.__.Documents,encoding:T.Wi.UTF8})})()}readSecretFile(){return(0,l.A)(function*(){const t=yield C.readFile({path:"secrets/text.txt",directory:T.__.Documents,encoding:T.Wi.UTF8});console.log("secrets:",t)})()}deleteSecretFile(){return(0,l.A)(function*(){yield C.deleteFile({path:"secrets/text.txt",directory:T.__.Documents})})()}convertToCSV(t){if(!t||!t.length)return"";const p=Object.keys(t[0]);return[p.join(","),...t.map(_=>p.map(k=>_[k]).join(","))].join("\n")}}return(a=g).\u0275fac=function(t){return new(t||a)(e.rXU(P.P),e.rXU(h.Y))},a.\u0275cmp=e.VBU({type:a,selectors:[["app-data"]],decls:9,vars:3,consts:[[3,"fullscreen"],["collapse","condense"],["size","large"],["class","ion-text-center",4,"ngIf"],[4,"ngIf"],[1,"ion-text-center"],[3,"click"],[1,"custom-progress-bar",3,"value"]],template:function(t,n){1&t&&(e.j41(0,"ion-content",0)(1,"ion-header",1)(2,"ion-toolbar")(3,"ion-title",2),e.EFF(4,"Data"),e.k0s()()(),e.DNE(5,I,3,0,"div",3)(6,U,5,1,"ion-card",4),e.j41(7,"div"),e.nrm(8,"app-page-data-reader"),e.k0s()()),2&t&&(e.Y8G("fullscreen",!0),e.R7$(5),e.Y8G("ngIf",!n.isDownloading),e.R7$(),e.Y8G("ngIf",n.isDownloading))},dependencies:[D.bT,d.Jm,d.b_,d.I9,d.W9,d.eU,d.he,d.FH,d.BC,d.ai,y]}),g})()}];let w=(()=>{var a;class g{}return(a=g).\u0275fac=function(t){return new(t||a)},a.\u0275mod=e.$C({type:a}),a.\u0275inj=e.G2t({imports:[E.iI.forChild(A),E.iI]}),g})(),x=(()=>{var a;class g{}return(a=g).\u0275fac=function(t){return new(t||a)},a.\u0275mod=e.$C({type:a}),a.\u0275inj=e.G2t({imports:[D.MD,F.YN,d.bv,w]}),g})()},9855:($,S,r)=>{r.d(S,{Y:()=>l});var D=r(467),F=r(4438),d=r(3643),E=r(5432);let l=(()=>{var b;class T{constructor(){this.totalPagesSignal=(0,F.vPA)(0),this.progress=(0,F.vPA)(0),this.fullFlashData=[],this.fullFlashPages=0}parseDataReading(e){const P=e.byteLength;if(P%16!=0)throw new Error("Data length is not a multiple of 16 bytes.");const u=[];for(let m=0;m<P&&!(m+16>P);m+=16){const s=e.getUint32(m,!0),c=e.getUint16(m+4,!0),i=e.getUint8(m+6),R=!!(128&i),f=127&i,y=e.getUint16(m+7,!0),I=e.getUint16(m+9,!0),j=e.getUint16(m+11,!0);u.push({timestamp:Number(s),sensorValue:c,isMotorRunning:R,pumpMode:f,batteryReading:y,lowThreshold:I,highThreshold:j})}return u}onReadFlashData(e){var P=this;return(0,D.A)(function*(){P.readTotalPages(e),P.fullFlashPages=0;const h=E.T.dataServiceUUID,u=E.T.readFullFlashCharUUID;yield d.Fk.read(e,h,u)})()}readTotalPages(e){var P=this;return(0,D.A)(function*(){try{const u=(yield yield d.Fk.read(e,E.T.deviceServiceUUID,E.T.totalPagesCharUUID)).getUint32(0,!0);return P.totalPagesSignal.set(u),u}catch(h){throw console.error("Error reading total pages:",h),h}})()}}return(b=T).\u0275fac=function(e){return new(e||b)},b.\u0275prov=F.jDH({token:b,factory:b.\u0275fac,providedIn:"root"}),T})()},8263:($,S,r)=>{r.d(S,{P:()=>e});var D=r(467),F=r(4438),d=r(5432),E=r(3643),l=r(5816);class b{static parseDataReading(u){const m=u.byteLength;if(m%16!=0)throw new Error("Data length is not a multiple of 16 bytes.");const c=[];for(let i=0;i<m&&!(i+16>m);i+=16){const R=u.getUint32(i,!0),f=u.getUint16(i+4,!0),y=u.getUint8(i+6),I=!!(128&y),j=127&y,U=u.getUint16(i+7,!0),M=u.getUint16(i+9,!0),A=u.getUint16(i+11,!0);c.push({timestamp:Number(R),sensorValue:f,isMotorRunning:I,pumpMode:j,batteryReading:U,lowThreshold:M,highThreshold:A})}return c}}var T=r(1727),C=r(9855);let e=(()=>{var h;class u{constructor(s,c){this.bluetoothConnectionService=s,this.bluetoothDataService=c,this.allPageData=(0,F.vPA)([]),this.singlePageData=(0,F.vPA)([])}readCurrentPage(){var s=this;return(0,D.A)(function*(){try{const c=yield E.Fk.read(s.bluetoothConnectionService.deviceIDSignal(),d.T.dataServiceUUID,d.T.currentPageCharUUID);return c.byteLength>0?l.N.parseInt32DataReading(c):(console.log("No page number received from device"),null)}catch(c){return console.error("Error reading page number:",c),null}})()}readPageData(s){var c=this;return(0,D.A)(function*(){try{const i=new DataView(new ArrayBuffer(4));i.setInt32(0,256*s,!0),console.log(`Setting page offset to ${s}`),console.log("Page offset buffer:",i),yield E.Fk.write(c.bluetoothConnectionService.deviceIDSignal(),d.T.dataServiceUUID,d.T.pageOffsetWriteCharUUID,i),console.log(`Reading data for page ${s}`);const f=yield E.Fk.read(c.bluetoothConnectionService.deviceIDSignal(),d.T.dataServiceUUID,d.T.pageDataCharUUID);return f.byteLength>0?(console.log(`Page ${s} data:`,f),Array.from(b.parseDataReading(f))):(console.log(`No data received for page ${s}`),null)}catch(i){return console.error(`Error reading data for page ${s}:`,i),null}})()}readMultiplePages(s,c,i=5){var R=this;return(0,D.A)(function*(){const f=[];for(let y=0;y<c;y+=i){const I=Array.from({length:Math.min(i,c-y)},(U,M)=>R.readPageData(s+y+M)),j=yield Promise.all(I);f.push(...j.filter(U=>null!==U).flat())}return f})()}readSinglePage(s){var c=this;return(0,D.A)(function*(){const i=yield c.readCurrentPage();if(null===i)return console.error("Could not determine current page"),[];if(s>i)return console.error("Page number is greater than current page"),[];console.log(`Reading single page ${s}`);const R=yield c.readPageData(s);return P(R)})()}readAllPages(){var s=this;return(0,D.A)(function*(){const c=yield s.readCurrentPage();if(null===c)return console.error("Could not determine current page"),[];const i=[];for(let f=0;f<c;f++){s.bluetoothDataService.progress.set(f/(c-1)),console.log(`Reading page ${f}`);const y=yield s.readPageData(f);null!==y&&i.push(...y)}const R=P(i);return s.allPageData.set(R),R})()}}return(h=u).\u0275fac=function(s){return new(s||h)(F.KVO(T.c),F.KVO(C.Y))},h.\u0275prov=F.jDH({token:h,factory:h.\u0275fac,providedIn:"root"}),u})();const P=h=>(h=h.filter(u=>255!==u.sensorValue)).map(u=>({...u,timestamp:1e3*u.timestamp}))}}]);